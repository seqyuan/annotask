<p align="center">
  <img src="https://raw.githubusercontent.com/seqyuan/annotask-doc/main/.vuepress/public/logo.svg" alt="annotask logo" width="200" height="200">
</p>

<p align="center">
  <h2>annotask</h2>
  <p><strong>Annoroad parallel task tool</strong> - 并行任务执行工具</p>
  <p>A Go binary for parallel task execution with local and SGE cluster support</p>
</p>

---

# 程序功能

`annotask` 是一个高效的并行任务执行工具，专为处理大量独立、需要并行运行的脚本任务而设计。通过智能的任务分组、并发控制和状态管理，显著减少任务投递开销，提高执行效率。

## 核心特性

### 🚀 双模式执行
- **本地并行模式（local）**：在本地机器上并行执行任务，适合单机多核环境
- **SGE 集群模式（qsubsge）**：通过 DRMAA 接口将任务投递到 SGE 集群执行，支持大规模分布式计算
  - 支持两种并行环境模式：默认模式（`-pe smp X`）和 num_proc 模式（`-l p=X`）
  - 灵活的资源管理：可指定 CPU、内存（vf/h_vmem）、队列、SGE 项目等参数
  - 节点安全检查：防止在计算节点误投递任务

### 📦 智能任务管理
- **任务分组**：支持将输入文件按行分组（`-l` 参数），将多个命令合并为一个任务单元执行
- **断点续传**：基于 SQLite 数据库记录任务状态，支持中断后继续执行
  - 已成功完成的任务会被自动跳过，只执行失败或未执行的任务
  - 每个任务独立执行，互不影响，失败任务不会阻塞其他任务
- **并发控制**：可指定最大并发任务数（`-p` 参数），灵活控制资源使用

### 🔄 自动重试机制
- **智能重试**：失败任务最多自动重试 3 次（可在配置文件中自定义）
- **内存自适应重试**：在 qsubsge 模式下，如果任务因内存不足被 SGE kill
  - 自动检测内存相关错误（OOM、h_vmem 超限等）
  - 下次重试时自动将用户显式设置的内存参数增加 125%（向上取整）
  - 仅针对用户显式设置的内存参数（`--mem` 或 `--h_vmem`）进行自适应调整

### 📊 实时监控与状态跟踪
- **实时状态输出**：以表格形式实时输出任务状态变化到日志文件
  - 日志文件位置：`{输入文件路径}.log`（例如：`input.sh.log`）
  - 显示字段：重试轮次、任务编号、状态、任务ID、退出码、时间
  - 默认每 60 秒更新一次（可通过配置文件中的 `monitor_update_interval` 参数自定义），及时反馈任务执行情况
- **全局任务数据库**：记录所有项目的任务执行历史
  - 支持按项目查询任务状态（`stat` 模块）
  - 支持删除任务记录（`delete` 模块）
  - 便于任务管理和历史追溯

### 📝 完善的日志与输出
- **独立日志文件**：每个任务的 stdout 和 stderr 输出到独立文件（`.o` 和 `.e` 文件）
- **执行统计**：程序结束时统计成功和失败的任务数量
  - 成功和失败数量输出到标准输出
  - 失败任务的路径输出到标准错误
  - **重要：如果有任何任务失败，程序退出码为非 0，整个程序报错退出**

### 🎯 项目管理
- **项目组织**：支持通过项目名称组织和管理任务
- **两级配置管理**：支持用户级和系统级配置文件
  - 用户配置文件（`~/.annotask/annotask.yaml`）：用户个人默认设置，优先级高
  - 系统配置文件（程序目录下的 `annotask.yaml`）：系统级默认设置
  - 首次空运行 `annotask` 时自动创建用户配置文件
  - 配置优先级：命令行参数 > 用户配置 > 系统配置 > 程序默认值

## 重要说明

**程序退出机制**：程序子task只要有一个未成功（退出码非0），则整个程序报错退出（退出码为非0）。这意味着：
- 所有任务必须全部成功，程序才会正常退出（退出码为0）
- 如果有任何任务失败，程序会输出失败任务的详细信息到标准错误，并以非0退出码退出
- 这个机制确保了任务执行的完整性，便于在脚本或工作流中检测任务执行状态

## 适用场景

- **批量数据处理**：大量独立的任务，如批量文件处理、数据转换等
- **生物信息学分析**：大量样本的独立分析任务，如序列比对、注释等
- **并行计算任务**：需要并发执行但相互独立的计算任务
- **集群作业管理**：需要将大量小任务投递到 SGE 集群的场景

## 文档导航

- **[安装与配置](INSTALL.md)** - 安装说明、总配置和个性化配置说明
- **[本地与集群模式](local_qsubsge.md)** - local 和 qsubsge 模式的详细使用方法
- **[任务状态查询](stat.md)** - 使用 `stat` 模块查询任务状态
- **[任务记录删除](delete.md)** - 使用 `delete` 模块删除任务记录
- **[数据库结构](database.md)** - 本地任务数据库和全局任务数据库的详细说明

## 快速开始

1. **安装程序**：详见 [INSTALL.md](INSTALL.md)
2. **配置环境**：配置用户级或系统级配置文件，详见 [INSTALL.md](INSTALL.md)
3. **运行任务**：
   - 本地模式：`annotask -i input.sh -l 2 -p 4 --project myproject`
   - 集群模式：`annotask qsubsge -i input.sh -l 2 -p 4 --project myproject --cpu 2 --h_vmem 8`
4. **查看状态**：`annotask stat` 或 `annotask stat -p myproject`
5. **管理任务**：`annotask delete -p myproject` 或 `annotask delete -p myproject -m module`

## 常见问题

### 并行子进程中其中有些子进程出错怎么办？

例如示例所示`input.sh`中的第2个和第3个子脚本出错，那么待`input.sh`退出后，修正子脚本的命令行，再重新运行或者投递`input.sh`即可。在重新运行`work.sh`时，annotask会自动跳过已经成功完成的子脚本，只运行出错的子脚本。

如果任务失败，annotask会自动重试（最多3次），无需手动重新运行。
