# 更新日志 (Update Log)

本文档记录了 annotask 各个版本的更新内容和变更历史。

---

## v1.8.9 (2025-01)

### 🎯 重大改进

#### qsubsge 模式输出文件位置优化
- **简化目录切换逻辑**：
  - 移除了复杂的互斥锁保护机制
  - 在投递任务前统一切换到 `{script}.shell` 目录
  - 所有子任务脚本都在同一目录，只需切换一次即可
  - 输出文件 `task_00XX.sh.o{jobid}` 和 `task_00XX.sh.e{jobid}` 会生成在脚本所在目录
  - 参考了 [goqsub](https://github.com/seqyuan/goqsub) 的实现方式

#### Stat 命令功能增强
- **自动状态更新**：
  - `annotask stat` 命令现在会自动从本地数据库读取最新任务状态并更新到全局数据库
  - 确保显示的信息始终是最新的，无需手动刷新
- **输出格式优化**：
  - `statis` 字段格式从 `总任务数/待处理任务数` 改为 `已完成数/总任务数`（更直观）
  - 查询特定项目时，shell 路径输出格式从 `模块名_完整路径` 改为 `id 完整路径`（更清晰）
  - 添加了任务 ID 列，便于快速定位任务

#### 监控性能优化
- **更新间隔调整**：
  - 全局数据库更新间隔默认值从 5 秒调整为 60 秒
  - 减少数据库负载和锁竞争，提高多进程并发运行时的性能
  - 可通过配置文件中的 `monitor_update_interval` 参数自定义

#### Shell 脚本生成改进
- **日期命令格式优化**：
  - 将反引号命令替换改为 `$(date ...)` 格式，符合现代 bash 最佳实践
  - 提高脚本兼容性和可读性

### 📝 详细变更

1. **代码修改**
   - `local.go`: 在 qsubsge 模式下，在投递前切换目录到 `{script}.shell`
   - `task.go`: 移除复杂的目录切换和互斥锁逻辑，简化实现
   - `stat.go`: 添加自动状态更新功能，优化输出格式
   - `monitor.go`: 更新间隔默认值从 5 秒改为 60 秒
   - `shell.go`: 日期命令格式从反引号改为 `$(date ...)`

2. **文档更新**
   - 更新 `README.md` 中的 stat 命令说明和输出格式
   - 更新 `README.md` 中的 monitor_update_interval 默认值说明
   - 更新版本号到 v1.8.9

---

## v1.8.1 (2025-12)

### 🎯 重大改进

#### 用户配置文件支持
- **两级配置系统**：支持用户级和系统级配置文件
  - 用户配置文件：`~/.annotask/annotask.yaml`（用户 home 目录下的 `.annotask` 目录）
  - 系统配置文件：程序目录下的 `annotask.yaml`
  - 配置优先级：命令行参数 > 用户配置 > 系统配置 > 程序默认值
- **自动创建用户配置**：
  - 首次空运行 `annotask` 时，自动在用户 home 目录下的 `.annotask` 目录创建 `annotask.yaml`
  - 默认内容：`db: ~/.annotask/annotask.db`, `retry.max: 3`, `queue: sci.q`, `sge_project: ""`
- **数据库路径智能回退**：
  - 如果用户配置的 db 路径不存在，自动回退到系统配置的 db 路径
  - 如果系统配置的 db 路径也不存在，使用用户配置的 db 路径（会自动创建）
  - 确保数据库文件始终可以正常创建和使用
- **智能配置合并**：
  - 用户配置优先于系统配置
  - 命令行参数优先于所有配置文件
  - 投递时自动使用用户配置中的 `queue` 和 `retry.max`（如果命令行未指定）

#### 并行环境模式改进
- **`--mode` 参数替代 `--pesmp`**：
  - 移除 `--pesmp` 标志参数
  - 新增 `--mode` 字符串参数，支持 `pe_smp`（默认）和 `num_proc`
  - 默认模式改为 `pe_smp`（使用 `-pe smp X`）
  - `num_proc` 模式使用 `-l p=X`

### 📝 详细变更

1. **代码修改**
   - `config.go`: 添加 `LoadConfig()` 支持两级配置加载和合并
   - `config.go`: 添加 `EnsureUserConfig()` 函数，自动创建用户配置文件
   - `config.go`: 添加 `mergeConfig()` 函数，实现配置合并逻辑
   - `main.go`: 空运行时自动创建用户配置文件
   - `qsubsge.go`: 移除 `--pesmp`，添加 `--mode` 参数
   - `qsubsge.go`: 优化参数获取逻辑，优先使用用户配置
   - `task.go`: 更新并行环境模式判断逻辑，使用 `parallelEnvMode` 字符串
   - `types.go`: 添加 `ParallelEnvMode` 类型定义

2. **文档更新**
   - 更新 `README.md` 中的配置文件说明，添加用户配置文件章节
   - 更新所有参数说明，明确配置优先级
   - 更新 `ARCHITECTURE.md` 中的并行环境模式说明

---

## v1.7.8 (2025-12)

### 🎯 重大改进

#### 参考 goqsub 的投递模式优化
- **内存参数映射修正**：
  - `--mem` 参数现在映射到 SGE 的 `vf` 资源（虚拟内存），DRMAA 投递时使用 `-l vf=XG`
  - `--h_vmem` 参数映射到 SGE 的 `h_vmem` 资源（硬虚拟内存限制），DRMAA 投递时使用 `-l h_vmem=XG`
  - 修正了之前使用 `-l mem=XG` 的错误，现在与 [goqsub](https://github.com/seqyuan/goqsub) 保持一致
- **参数行为保持一致**：
  - 如果只设置了 `--mem`，DRMAA 投递时只包含 `-l vf=XG`，不包含 `-l h_vmem`
  - 如果只设置了 `--h_vmem`，DRMAA 投递时只包含 `-l h_vmem=XG`，不包含 `-l vf`
  - 如果都不设置，DRMAA 投递时不会包含内存相关参数

#### 并行环境模式支持
- **添加 `--pesmp` 参数**：支持两种并行环境投递模式
  - **默认模式**（不设置 `--pesmp`）：使用 `-l p=X` 指定 CPU 数量
    - 示例：`--cpu 4 --h_vmem 18` → `-l h_vmem=18G,p=4`
  - **PE SMP 模式**（设置 `--pesmp`）：使用 `-pe smp X` 指定 CPU 数量
    - 示例：`--cpu 4 --h_vmem 5 --pesmp` → `-l h_vmem=5G -pe smp 4`
- **灵活的资源指定**：
  - CPU 数量通过 `--cpu` 参数指定
  - 内存参数（`--mem` 和 `--h_vmem`）根据用户显式设置的情况添加到 `-l` 规范中
  - 两种模式都支持所有其他参数（队列、SGE 项目等）

### 📝 详细变更

1. **代码修改**
   - `task.go`: 将 `-l mem=%dG` 改为 `-l vf=%dG`，与 goqsub 保持一致
   - `task.go`: 添加并行环境模式支持，根据 `--pesmp` 参数选择使用 `-l p=X` 或 `-pe smp X`
   - `qsubsge.go`: 添加 `--pesmp` 标志参数
   - `local.go`: 更新函数签名，添加 `usePesmp` 参数
   - 添加注释说明参数映射关系和并行环境模式

2. **文档更新**
   - 更新 `main.go` 中的帮助信息，明确说明 `--mem` 映射到 `vf`，`--h_vmem` 映射到 `h_vmem`，添加 `--pesmp` 说明
   - 更新 `qsubsge.go` 中的参数帮助信息
   - 更新 `README.md` 中的参数说明、重要说明部分和并行环境模式说明

---

## v1.7.1 (2025-12)

### 🎯 重大改进

#### QsubSGE 模式参数优化
- **内存参数行为变更**：
  - `--mem` 和 `--h_vmem` 参数现在只在用户显式设置时才会在 DRMAA 投递时使用
  - `--mem` 对应 SGE 的 `vf` 资源（虚拟内存），DRMAA 投递时使用 `-l vf=XG`
  - `--h_vmem` 对应 SGE 的 `h_vmem` 资源（硬虚拟内存限制），DRMAA 投递时使用 `-l h_vmem=XG`
  - 如果用户只设置了 `--mem`，DRMAA 投递时只包含 `-l vf=XG`，不包含 `-l h_vmem`
  - 如果用户只设置了 `--h_vmem`，DRMAA 投递时只包含 `-l h_vmem=XG`，不包含 `-l vf`
  - 如果都不设置，DRMAA 投递时不会包含内存相关参数
- **移除配置文件中的 mem 字段**：
  - 配置文件不再包含 `defaults.mem` 字段
  - 内存参数必须通过命令行显式指定
- **添加队列参数**：
  - 新增 `--queue` 参数，支持指定单个或多个队列（逗号分隔）
  - 例如：`--queue trans.q,nassci.q,sci.q`
  - 默认值从配置文件中的 `queue` 字段读取
- **添加 SGE 项目参数**：
  - 新增 `-P/--sge-project` 参数，用于 SGE 资源配额管理
  - 默认值从配置文件中的 `sge_project` 字段读取
  - 如果未设置，DRMAA 投递时不使用 `-P` 参数

#### 内存自适应重试优化
- **智能内存增加**：
  - 重试时根据用户设置的参数，只增加相应参数的内存
  - 如果用户只设置了 `--mem`，只增加 `mem`；如果只设置了 `--h_vmem`，只增加 `h_vmem`
  - 内存增加时使用向上取整（`math.Ceil`），确保有足够的内存

#### Stat 模块改进
- **移除 `-m` 参数**：
  - 移除了 `stat` 模块的 `-m/--module` 参数
  - 使用 `-p` 参数时会自动显示 shellPath 列表
- **输出格式优化**：
  - 无 `-p` 时：显示所有项目的汇总表格（`project module mode status statis stime etime`）
  - 有 `-p` 时：显示项目详情表格（`module pending running failed finished stime etime`）+ shellPath 列表

#### 监控输出改进
- **表格格式输出**：
  - 监控输出改为表格格式，包含表头
  - 添加 `try` 列，显示当前重试轮次/最大重试次数（例如：`1:3`）
  - 移除 `[NEW]` 和 `[RETRY-N]` 前缀标记
  - 移除 "Retry round X: Y tasks to retry" 消息
  - 移除 `retry` 列（因为已有 `try` 列显示重试信息）
  - Pending 状态的任务不再显示在监控输出中
  - 时间格式统一为 "MM-DD HH:MM"

#### 节点检查改进
- **支持多个允许节点**：
  - `node` 字段现在支持列表格式，可以设置多个允许的节点
  - 如果 `node` 为空或不设置，则不对 qsubsge 模式做节点限制
  - 如果设置了节点列表，当前节点必须在列表中才能使用 qsubsge 模式
  - 提高了配置的灵活性，支持在多个登录节点上使用 qsubsge 模式

### 📝 详细变更

1. **参数行为**
   - `--mem` 和 `--h_vmem` 仅在显式设置时使用
   - 配置文件不再包含 `mem` 字段
   - 添加 `--queue` 和 `-P/--sge-project` 参数

2. **代码优化**
   - 内存自增使用 `math.Ceil` 向上取整
   - 重试时根据用户设置的参数智能增加内存
   - 监控输出格式优化，移除冗余信息

3. **节点检查优化**
   - `node` 字段从单个字符串改为列表格式，支持多个允许的节点
   - 空列表表示无节点限制，提高了配置灵活性

4. **文档更新**
   - 更新 README.md 中的参数说明和节点检查说明
   - 更新配置文件示例，展示 node 列表格式
   - 更新监控输出格式说明
   - 更新常见问题部分的节点检查错误信息

---

## v1.7.1 (2025-12)

### 🎯 重大改进

#### 代码架构重构
- **模块化拆分**：将原本 1400+ 行的 `main.go` 拆分为多个功能模块文件，大幅提升代码可维护性
  - `types.go` - 类型定义和常量
  - `config.go` - 配置管理
  - `database.go` - 数据库操作
  - `shell.go` - Shell脚本生成
  - `task.go` - 任务执行核心逻辑
  - `monitor.go` - 任务监控
  - `utils.go` - 工具函数
  - `local.go` - local 模块实现
  - `qsubsge.go` - qsubsge 模块实现
  - `stat.go` - stat 模块实现
  - `delete.go` - delete 模块实现
  - `main.go` - 主入口和CLI路由（精简至 ~160 行）

#### 命令行界面改进
- **模块化设计**：将主命令选项移到 `local` 模块，实现真正的模块化架构
- **智能默认行为**：
  - 空运行程序时显示模块列表
  - 直接使用选项参数（如 `-i file.sh`）时自动使用 `local` 模块
  - 支持显式指定模块：`annotask local -i file.sh`
- **改进的帮助系统**：
  - `annotask` - 显示模块列表
  - `annotask <module> --help` - 显示特定模块的详细帮助
  - 每个模块都有独立的帮助信息

#### 安装改进
- **可执行文件名称**：安装后的可执行文件名称从 `app` 改为 `annotask`
- **Grid Engine 支持**：完善了使用 Grid Engine 自带 DRMAA 库的编译安装说明
  - 支持自动查找 DRMAA 头文件和库文件路径
  - 提供详细的 CGO 编译标志设置方法
  - 更新了 `INSTALL.md` 文档

### 📝 详细变更

1. **代码组织**
   - 所有文件统一在 `cmd/annotask/` 目录下
   - 每个模块职责单一，便于维护和测试
   - 代码行数从单文件 1433 行优化为平均 100-150 行/文件

2. **用户体验**
   - 更直观的命令行界面
   - 更好的帮助信息展示
   - 更清晰的模块划分

3. **文档更新**
   - 更新 `INSTALL.md` 添加 Grid Engine DRMAA 库安装说明
   - 更新所有安装命令中的路径（`cmd/app` → `cmd/annotask`）

### 🔧 技术细节

- **包结构**：所有文件保持 `package main`，确保功能完整性
- **向后兼容**：所有功能保持不变，仅改进代码组织和用户体验
- **编译要求**：Go 1.22.2+，CGO_ENABLED=1

---

## v1.6.0

### 新增功能
- 添加全局任务数据库，支持跨项目任务管理
- 添加 `stat` 子命令：查询任务状态
  - 支持按项目过滤
  - 支持显示 shell 路径
  - 显示任务统计信息（Pending, Failed, Running, Finished）
- 添加 `delete` 子命令：删除任务记录
  - 支持删除整个项目
  - 支持删除特定模块
- 改进任务监控：实时输出任务状态变化
- 数据库迁移：`basename` 列重命名为 `module`

### 改进
- 优化任务状态更新逻辑
- 改进错误处理和日志输出
- 完善配置文件支持

---

## v1.5.0

### 重大更新
- **重命名包名**：从 `app` 改为 `annotask`
- **添加 qsubsge 子命令**：支持 SGE 集群投递
  - 支持 CPU、内存、虚拟内存配置
  - 自动生成 SGE 作业输出文件
  - 支持节点检查
- **自动重试机制**：
  - 失败任务自动重试，最多 3 次（可配置）
  - 重试次数记录在数据库中
- **内存自适应重试**：
  - 检测内存不足错误（退出码 137 或错误日志关键词）
  - 自动将内存请求增加 125% 后重试
- **实时任务状态监控**：
  - 独立 goroutine 监控任务状态
  - 实时输出状态变化到标准输出
  - 支持任务重试标记
- **项目管理和全局数据库**：
  - 支持项目名称管理
  - 全局数据库记录所有任务
  - 支持任务统计查询
- **YAML 配置文件**：
  - 自动创建 `annotask.yaml` 配置文件
  - 支持默认参数配置
  - 支持重试次数配置
- **数据库改进**：
  - 列名从 `basename` 改为 `module`
  - 添加任务统计字段

### 技术改进
- 使用 DRMAA 库进行 SGE 作业管理
- 改进错误处理机制
- 优化数据库查询性能

---

## v1.4.0

### 初始版本
- 基本的本地并行任务执行功能
- 支持通过 `-l` 参数指定每几行作为一个任务
- 支持通过 `-p` 参数指定最大并发数
- 支持任务失败后重新运行（跳过已成功的任务）
- 使用 SQLite 数据库记录任务状态
- 支持任务输出重定向到 `.o` 和 `.e` 文件

---

## 版本说明

### 版本号规则
- **主版本号**：重大架构变更或破坏性更新
- **次版本号**：新功能添加或重大改进
- **修订号**：bug 修复或小改进

### 如何查看当前版本
```bash
annotask
# 或
annotask --help
```

### 如何安装特定版本
```bash
# 安装 v1.7.0
CGO_ENABLED=1 go install github.com/seqyuan/annotask/cmd/annotask@v1.7.0

# 安装最新版本
CGO_ENABLED=1 go install github.com/seqyuan/annotask/cmd/annotask@latest
```

---

## 贡献

欢迎提交 Issue 和 Pull Request 来帮助改进 annotask！

---

*最后更新：2024-12*

